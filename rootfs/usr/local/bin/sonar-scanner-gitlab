#!/usr/bin/env sh

############################################################
# GitLab Sonar Integration
# --
# A default project key will be generated using the repository path.
############################################################

##
# Execution
##
COMMAND="sonar-scanner "

# Debug
if [ ! -z "$DEBUG" ]; then
	COMMAND="$COMMAND -X"
fi

# Host
COMMAND="-Dsonar.host=\"$SONAR_HOST\""

# Login Token
if [ ! -z "$SONAR_TOKEN" ]; then
	COMMAND="$COMMAND -Dsonar.login=\"$SONAR_TOKEN\""
fi


# Project Version
if [ ! -z "$SONAR_PROJECT_VERSION" ]; then
	COMMAND="$COMMAND -Dsonar.projectVersion=\"$SONAR_PROJECT_VERSION\""
fi

# GitLab - Auto Configuration
# - Project Key
SONAR_PROJECT_KEY="gitlab:$CI_PROJECT_PATH"
COMMAND="-Dsonar.projectKey=\"$SONAR_PROJECT_KEY\""


# - Project Id
if [ ! -z "$CI_PROJECT_ID" ]; then
	COMMAND="$COMMAND -Dsonar.gitlab.project_id=\"$CI_PROJECT_ID\""
fi
# - Project Name
if [ ! -z "$SONAR_PROJECT_NAME" ]; then
	COMMAND="$COMMAND -Dsonar.projectName=\"$SONAR_PROJECT_NAME\""
fi
# - Branch
if [ ! -z $CI_COMMIT_REF_NAME ]; then
	COMMAND="$COMMAND -Dsonar.branch=\"$CI_COMMIT_REF_NAME\""
fi
# - Commit Hash
if [ ! -z $CI_BUILD_REF ]; then
	COMMAND="$COMMAND -Dsonar.gitlab.commit_sha=\"$CI_BUILD_REF\""
fi
# - Commit Ref Name
if [ ! -z $CI_BUILD_REF_NAME ]; then
	COMMAND="$COMMAND -Dsonar.gitlab.ref_name=\"$CI_BUILD_REF_NAME\""
fi

# SourceCode Directory
if [ ! -z "$SONAR_SOURCES" ]; then
	COMMAND="$COMMAND -Dsonar.sources=\"$SONAR_SOURCES\""
else
	COMMAND="$COMMAND -Dsonar.sources=\".\""
fi

# Analysis Configuration
COMMAND="$COMMAND -Dsonar.analysis.mode=\"$SONAR_ANALYSIS_MODE\""
COMMAND="$COMMAND -Dsonar.issuesReport.console.enable=true"

# PROFILE???????
if [ ! -z "$SONAR_PROFILE" ]; then
	COMMAND="$COMMAND -Dsonar.profile=\"$SONAR_PROFILE\""
fi

# O: Language (Java/...)
if [ ! -z "$SONAR_LANGUAGE" ]; then
	COMMAND="$COMMAND -Dsonar.language=\"$SONAR_LANGUAGE\""
fi

eval $COMMAND
