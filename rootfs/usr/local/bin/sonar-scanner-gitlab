#!/usr/bin/env sh

############################################################
# GitLab Sonar Integration
# --
# A default project key will be generated using the repository path.
############################################################

##
# Execution
##
COMMAND="sonar-scanner "

# Host
COMMAND="$COMMAND -Dsonar.host.url=\"$SONAR_HOST\""

# Login Token
if [ ! -z "$SONAR_TOKEN" ]; then
	COMMAND="$COMMAND -Dsonar.login=\"$SONAR_TOKEN\""
fi


# Project Version
if [ ! -z "$SONAR_PROJECT_VERSION" ]; then
	COMMAND="$COMMAND -Dsonar.projectVersion=\"$SONAR_PROJECT_VERSION\""
fi

# GitLab - Auto Configuration
# - Project Key
SONAR_PROJECT_KEY=$(echo "$CI_PROJECT_NAMESPACE:$CI_PROJECT_NAME" | sed -r 's/\\/_/g')
COMMAND="$COMMAND -Dsonar.projectKey=\"$SONAR_PROJECT_KEY\""

# - Project Id
if [ ! -z "$CI_PROJECT_ID" ] && [ "$SONAR_ANALYSIS_MODE" == "preview" ]; then
	COMMAND="$COMMAND -Dsonar.gitlab.project_id=\"$CI_PROJECT_ID\""
fi

# - Commit Hash
if [ ! -z $CI_BUILD_REF ] && [ "$SONAR_ANALYSIS_MODE" == "preview" ]; then
	COMMAND="$COMMAND -Dsonar.gitlab.commit_sha=\"$CI_BUILD_REF\""
fi

# - Commit Ref Name
if [ ! -z $CI_BUILD_REF_NAME ] && [ "$SONAR_ANALYSIS_MODE" == "preview" ]; then
	COMMAND="$COMMAND -Dsonar.gitlab.ref_name=\"$CI_BUILD_REF_NAME\""
fi

# - Project Name
if [ ! -z "$CI_PROJECT_NAME" ]; then
	COMMAND="$COMMAND -Dsonar.projectName=\"$CI_PROJECT_NAMESPACE / $CI_PROJECT_NAME\""
fi

# - Branch
if [ ! -z $CI_COMMIT_REF_NAME ]; then
	COMMAND="$COMMAND -Dsonar.branch=\"$CI_COMMIT_REF_NAME\""
fi

# - Project Link
if [ ! -z $CI_PROJECT_URL ]; then
	COMMAND="$COMMAND -Dsonar.links.homepage=\"$CI_PROJECT_URL\""
fi

# - Debug Enabled?
if [ ! -z "$CI_DEBUG_TRACE" ]; then
	COMMAND="$COMMAND -X"
fi

# SourceCode Directory
if [ ! -z "$SONAR_SOURCES" ]; then
	COMMAND="$COMMAND -Dsonar.sources=\"$SONAR_SOURCES\""
else
	COMMAND="$COMMAND -Dsonar.sources=\".\""
fi

# Analysis Configuration
COMMAND="$COMMAND -Dsonar.analysis.mode=\"$SONAR_ANALYSIS_MODE\""
COMMAND="$COMMAND -Dsonar.issuesReport.console.enable=true"

# Set a Language (defaults to multi-language analysis)
if [ ! -z "$SONAR_LANGUAGE" ]; then
	COMMAND="$COMMAND -Dsonar.language=\"$SONAR_LANGUAGE\""
fi

# Run Scanner
eval $COMMAND
